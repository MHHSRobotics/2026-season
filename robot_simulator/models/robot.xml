<mujoco model="frc_swerve_robot">
  <compiler angle="radian" autolimits="true"/>

  <option gravity="0 0 -9.81" timestep="0.005" solver="PGS" iterations="50"/>

  <visual>
    <headlight ambient="0.5 0.5 0.5"/>
  </visual>

  <default>
    <joint damping="0.1" armature="0.001"/>
    <geom friction="1.0 0.005 0.0001" condim="3"/>
    <motor ctrllimited="true" ctrlrange="-100 100"/>
    <default class="fuel">
      <geom friction="0.8 0.005 0.0001" condim="3"/>
    </default>
  </default>

  <asset>
    <material name="chassis_mat" rgba="0.2 0.2 0.2 1"/>
    <material name="bumper_mat" rgba="0.8 0.1 0.1 1"/>
    <material name="wheel_mat" rgba="0.1 0.1 0.1 1"/>
    <material name="module_mat" rgba="0.4 0.4 0.4 1"/>
  </asset>

  <include file="field.xml"/>

  <worldbody>
    <!-- Robot base (chassis) - freejoint allows 6DOF movement -->
    <!-- Starting position: blue alliance zone, centered on field width -->
    <body name="chassis" pos="2.0 4.035 0.12">
      <freejoint name="chassis_joint"/>

      <!-- IMU site for sensors -->
      <site name="imu_site" pos="0 0 0" size="0.01"/>

      <!-- Chassis geometry (27.5" x 27.5" x ~4" frame) -->
      <geom name="chassis_geom" type="box" size="0.349 0.349 0.05"
            mass="49.5" material="chassis_mat"/>

      <!-- Bumpers (3.25" thick, 5" tall) -->
      <geom name="bumper_front" type="box" pos="0.39 0 -0.02365" size="0.04 0.39 0.065"
            mass="2" material="bumper_mat"/>
      <geom name="bumper_back" type="box" pos="-0.39 0 -0.02365" size="0.04 0.39 0.065"
            mass="2" material="bumper_mat"/>
      <geom name="bumper_left" type="box" pos="0 0.39 -0.02365" size="0.39 0.04 0.065"
            mass="2" material="bumper_mat"/>
      <geom name="bumper_right" type="box" pos="0 -0.39 -0.02365" size="0.39 0.04 0.065"
            mass="2" material="bumper_mat"/>

      <!-- Front Left Module -->
      <body name="fl_module" pos="0.28 0.28 -0.07">
        <joint name="fl_steer" type="hinge" axis="0 0 1" damping="1.0" armature="0.011" frictionloss="2.0"/>
        <geom name="fl_housing" type="cylinder" size="0.04 0.03"
              mass="1" material="module_mat" contype="0" conaffinity="0"/>
        <body name="fl_wheel_body" pos="0 0 0">
          <joint name="fl_drive" type="hinge" axis="0 1 0" damping="0.01" armature="0.003"/>
          <geom name="fl_wheel" type="cylinder" size="0.05 0.02"
                euler="1.5708 0 0" mass="0.5" material="wheel_mat" friction="1.5 0.005 0.0001" contype="2" conaffinity="1"/>
        </body>
      </body>

      <!-- Front Right Module -->
      <body name="fr_module" pos="0.28 -0.28 -0.07">
        <joint name="fr_steer" type="hinge" axis="0 0 1" damping="1.0" armature="0.011" frictionloss="2.0"/>
        <geom name="fr_housing" type="cylinder" size="0.04 0.03"
              mass="1" material="module_mat" contype="0" conaffinity="0"/>
        <body name="fr_wheel_body" pos="0 0 0">
          <joint name="fr_drive" type="hinge" axis="0 1 0" damping="0.01" armature="0.003"/>
          <geom name="fr_wheel" type="cylinder" size="0.05 0.02"
                euler="1.5708 0 0" mass="0.5" material="wheel_mat" friction="1.5 0.005 0.0001" contype="2" conaffinity="1"/>
        </body>
      </body>

      <!-- Back Left Module -->
      <body name="bl_module" pos="-0.28 0.28 -0.07">
        <joint name="bl_steer" type="hinge" axis="0 0 1" damping="1.0" armature="0.011" frictionloss="2.0"/>
        <geom name="bl_housing" type="cylinder" size="0.04 0.03"
              mass="1" material="module_mat" contype="0" conaffinity="0"/>
        <body name="bl_wheel_body" pos="0 0 0">
          <joint name="bl_drive" type="hinge" axis="0 1 0" damping="0.01" armature="0.003"/>
          <geom name="bl_wheel" type="cylinder" size="0.05 0.02"
                euler="1.5708 0 0" mass="0.5" material="wheel_mat" friction="1.5 0.005 0.0001" contype="2" conaffinity="1"/>
        </body>
      </body>

      <!-- Back Right Module -->
      <body name="br_module" pos="-0.28 -0.28 -0.07">
        <joint name="br_steer" type="hinge" axis="0 0 1" damping="1.0" armature="0.011" frictionloss="2.0"/>
        <geom name="br_housing" type="cylinder" size="0.04 0.03"
              mass="1" material="module_mat" contype="0" conaffinity="0"/>
        <body name="br_wheel_body" pos="0 0 0">
          <joint name="br_drive" type="hinge" axis="0 1 0" damping="0.01" armature="0.003"/>
          <geom name="br_wheel" type="cylinder" size="0.05 0.02"
                euler="1.5708 0 0" mass="0.5" material="wheel_mat" friction="1.5 0.005 0.0001" contype="2" conaffinity="1"/>
        </body>
      </body>

    </body>
  </worldbody>

  <!-- Actuators: voltage-controlled motors -->
  <actuator>
    <motor name="fl_steer_motor" joint="fl_steer" gear="1"/>
    <motor name="fr_steer_motor" joint="fr_steer" gear="1"/>
    <motor name="bl_steer_motor" joint="bl_steer" gear="1"/>
    <motor name="br_steer_motor" joint="br_steer" gear="1"/>

    <motor name="fl_drive_motor" joint="fl_drive" gear="1"/>
    <motor name="fr_drive_motor" joint="fr_drive" gear="1"/>
    <motor name="bl_drive_motor" joint="bl_drive" gear="1"/>
    <motor name="br_drive_motor" joint="br_drive" gear="1"/>
  </actuator>

  <!-- Sensors for feedback to WPILib -->
  <sensor>
    <jointpos name="fl_steer_pos" joint="fl_steer"/>
    <jointpos name="fr_steer_pos" joint="fr_steer"/>
    <jointpos name="bl_steer_pos" joint="bl_steer"/>
    <jointpos name="br_steer_pos" joint="br_steer"/>

    <jointpos name="fl_drive_pos" joint="fl_drive"/>
    <jointpos name="fr_drive_pos" joint="fr_drive"/>
    <jointpos name="bl_drive_pos" joint="bl_drive"/>
    <jointpos name="br_drive_pos" joint="br_drive"/>

    <jointvel name="fl_steer_vel" joint="fl_steer"/>
    <jointvel name="fr_steer_vel" joint="fr_steer"/>
    <jointvel name="bl_steer_vel" joint="bl_steer"/>
    <jointvel name="br_steer_vel" joint="br_steer"/>

    <jointvel name="fl_drive_vel" joint="fl_drive"/>
    <jointvel name="fr_drive_vel" joint="fr_drive"/>
    <jointvel name="bl_drive_vel" joint="bl_drive"/>
    <jointvel name="br_drive_vel" joint="br_drive"/>

    <gyro name="chassis_gyro" site="imu_site"/>
    <accelerometer name="chassis_accel" site="imu_site"/>
  </sensor>

  <contact>
    <exclude body1="chassis" body2="fl_wheel_body"/>
    <exclude body1="chassis" body2="fr_wheel_body"/>
    <exclude body1="chassis" body2="bl_wheel_body"/>
    <exclude body1="chassis" body2="br_wheel_body"/>
  </contact>

</mujoco>
